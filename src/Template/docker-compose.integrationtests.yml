version: '3.4'

services:
  template.WebApp.integrationtests:
    container_name: temp.webapp.int-tests
    environment: 
      "ASPNETCORE_URLS": "https://0.0.0.0:443;http://0.0.0.0:80"
      "ASPNETCORE_HTTP_PORT": "8000"
      "ASPNETCORE_HTTPS_PORT": "8001"
      "ConnectionStrings__DefaultConnection": "Server=temp.sql.int-tests;Database=TemplateAppIntegrationTests;User Id=sa;Password=sa!Password-123;MultipleActiveResultSets=true;Encrypt=False;TrustServerCertificate=True;"
      "ConnectionStrings__AppConnection": "Server=temp.sql.int-tests;Database=TemplateApp;User Id=sa;Password=sa!Password-123;MultipleActiveResultSets=true;Encrypt=False;TrustServerCertificate=True;"
      "HealthChecksUI__HealthChecks__0__Uri": "https://localhost:8001/health"
      "HealthChecksUI__HealthChecks__1__Uri": "https://localhost:8001/health/databases"
    build:
      context: .
      dockerfile: Template.WebApp.IntegrationTests/Dockerfile
    depends_on:
      - template.sql
      - template.redis
    entrypoint: 
      [
        "/src/wait-for-it.sh", "temp.sql.int-tests:1433", "-t", "15", "--",
        "dotnet", "test", "/src/Template.WebApp.IntegrationTests/Template.WebApp.IntegrationTests.csproj", "--filter", "Category!=ExcludedFromBuild", "--logger", "trx", "--results-directory", "/var/temp", "-v", "d"
      ]
    volumes:
     - /opt/vsts/work/_temp:/var/temp

  template.redis:
    image: redis:alpine
    container_name: temp.redis.int-tests
    ports:
      - "8002:6379"
  
  template.sql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: temp.sql.int-tests
    ports:
      - "8003:1433"
    environment: 
      "ACCEPT_EULA": "Y"
      "SA_PASSWORD": "sa!Password-123"


