<?xml version="1.0" encoding="utf-8" ?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      autoReload="true"
      internalLogLevel="Info"
      internallogfile="${configsetting:item=NLog.Internallogfile}">

	<!-- enable asp.net core layout renderers -->
	<extensions>
		<add assembly="NLog.Web.AspNetCore"/>
	</extensions>

	<!-- the targets to write to -->
	<targets>

		<target name="database" xsi:type="Database" connectionString="${configsetting:item=ConnectionStrings.DefaultConnection}">
			<commandText>
				INSERT INTO log.Logs ([InsertDate], [IdLevelError], [LevelError], [SiteName], [ProcessName], [Message], [InnerException], [StackTrace],
				[UserAgent], [Headers], [Properties], [ClassMethod], [MachineName], [MachineIP], [Logger], [IdUser], [RemoteAddress], [FullReferer], [FullUrl])
				VALUES (@InsertDate, @IdLevelError, @LevelError, @SiteName, @ProcessName, @Message, @InnerException, @StackTrace, @UserAgent,
				@Headers, @Properties, @ClassMethod, @MachineName, @MachineIP, @Logger, @IdUser, @RemoteAddress, @FullReferer, @FullUrl);
			</commandText>

			<parameter name="@InsertDate"     layout="${date:format=yyyy-MM-dd HH\:mm\:ss.fff}" />
			<parameter name="@IdLevelError"   layout="${level-ordinal}" />
			<parameter name="@LevelError"     layout="${level:upperCase}" size="20" />
			<parameter name="@SiteName"       layout="${iis-application-name}" size="100" />
			<parameter name="@ProcessName"    layout="${processname}" size="100" />
			<parameter name="@Message"        layout="${message}" size="500" />
			<parameter name="@InnerException" layout="${exception:format=toString,StackTrace,Data:innerFormat=toString:maxInnerExceptionLevel=1}" size="4000" />
			<parameter name="@StackTrace"     layout="${stacktrace:format=DetailedFlat:topFrames=100}" size="4000" />
			<parameter name="@UserAgent"      layout="${aspnet-request-useragent}" size="1000" />
			<parameter name="@Headers"        layout="${http-headers}" size="4000" />
			<parameter name="@Properties"     layout="${all-event-properties:separator=#:includeCallerInformation:true}" size="1000"/>
			<parameter name="@ClassMethod"    layout="${callsite}"   size="250"/>
			<parameter name="@MachineName"    layout="${machinename}" size="30"/>
			<parameter name="@MachineIP"      layout="${machineip}" size="30"/>
			<parameter name="@Logger"         layout="${logger}" size="250"/>
			<parameter name="@IdUser"         layout="${aspnet-user-identity}" size="100" />
			<parameter name="@RemoteAddress"  layout="${aspnet-request-ip}" size="100"/>
			<parameter name="@FullReferer"    layout="${aspnet-request-referrer}" size="255" />
			<parameter name="@FullUrl"        layout="${aspnet-request-url:IncludePort=true:IncludeQueryString=true}" size="255" />
		</target>

		<target xsi:type="ColoredConsole"
			  name="lifetimeConsole"
			  encoding="utf-8"
			  layout="${longdate}|${level:uppercase=true}|${logger}|${message} ${exception:format=tostring}">

			<highlight-row condition="level == LogLevel.Debug" foregroundColor="DarkMagenta" />
			<highlight-row condition="level == LogLevel.Info" foregroundColor="Cyan" />
			<highlight-row condition="level == LogLevel.Warn" foregroundColor="DarkYellow" />
			<highlight-row condition="level == LogLevel.Error" foregroundColor="DarkRed" />
			<highlight-row condition="level == LogLevel.Fatal" foregroundColor="DarkRed" backgroundColor="White" />
		</target>

		<!-- File Target for all log messages with basic details -->
		<target xsi:type="File" 
				name="tracefile" 
				fileName="${configsetting:item=NLog.TraceFilePath}\Template.MvcWebApp-Trace-${shortdate}.log"
				layout="${longdate}|${event-properties:item=EventId:whenEmpty=0}|${level:uppercase=true}|${logger}|${message} ${exception:format=tostring}" />

		<!-- File Target for own log messages with extra web details using some ASP.NET core renderers -->
		<target xsi:type="File"
				name="logfile"
				fileName="${configsetting:item=NLog.LogFilePath}\Template.MvcWebApp-Logs-${shortdate}.log"
				layout="${longdate}|${level:uppercase=true}|${logger}|${message} ${exception:format=tostring}|url: ${aspnet-request-url}|action: ${aspnet-mvc-action}" />

	</targets>

	<!-- rules to map from logger name to target -->
	<rules>
		<!--All logs, including from Microsoft-->
		<logger name="Template.*" minlevel="Trace" writeTo="tracefile,lifetimeConsole" />

		<logger name="*" minlevel="Error" writeTo="database,lifetimeConsole" />

		<!--Output hosting lifetime messages to console target for faster startup detection -->
		<logger name="Microsoft.Hosting.Lifetime" minlevel="Trace" writeTo="lifetimeConsole" />
		
		<!--Skip non-critical Microsoft logs and so log only own logs (BlackHole) -->
		<logger name="Microsoft.*" maxlevel="Info" final="true" />
		<logger name="System.Net.Http.*" maxlevel="Info" final="true" />
	</rules>
</nlog>